-- Function: product_price(int,int,boolean,int,numeric)DROP FUNCTION product_price(int,int,boolean,int,numeric);CREATE OR REPLACE FUNCTION product_price(	in_client_id int,	in_production_city_id int,	in_to_third_party_only boolean,	in_product_id int,	in_quant numeric	)RETURNS record AS/*	price numeric	price_pack numeric	discount_total numeric*/$BODY$	--Прайс для клиента	WITH	pr_cl AS (		SELECT pr.price_list_id AS id		FROM client_price_list_clients AS pr		LEFT JOIN client_price_lists AS l ON l.id=pr.price_list_id		WHERE pr.client_id=$1			AND l.production_city_id=$2			AND l.to_third_party_only = $3	)	SELECT		prlp.price,					prlp.pack_price,		CASE			WHEN $5>=coalesce(prlp.discount_volume,0) THEN				coalesce(prlp.discount_total,0)			ELSE 0::numeric		END AS discount_total			FROM client_price_list_products AS prlp	LEFT JOIN client_price_lists AS prl ON prl.id=prlp.price_list_id	WHERE		prlp.product_id = $4		AND $5>=prl.min_order_quant		AND (			prlp.price_list_id IN (SELECT pr_cl.id FROM pr_cl)			OR prl.default_price_list		)		AND prl.to_third_party_only=$3	ORDER BY 		CASE			WHEN				prlp.price_list_id IN (SELECT pr_cl.id FROM pr_cl)				THEN 1			ELSE 2		END		LIMIT 1;$BODY$LANGUAGE sql;ALTER FUNCTION product_price(int,int,boolean,int,numeric) OWNER TO polimerplast;